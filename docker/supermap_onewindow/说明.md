# 此为生产环境

生产环境使用 portainer 管理 docker，分了预发布环境、正式环境两个部分。


## 部署步骤

1、部署 portainer

- 上传目录：`put -r D:\Code\1.ProjectAction\201909-mianyang\cloud-mian-yang\docker\supermap_onewindow /home/docker/supermap_onewindow`
- 导入 portainer 镜像
- 启动 portainer 容器
- 进入 portainer web页面
- 新建 network
- 新建 volume
- 上传 docker-compose.yml
- 依次执行，部署database、infrastructure、bootstrap、application

上传文件后要执行的命令备忘：
```
mkdir -p /home/docker/supermap_onewindow
docker network create one-window
chown -R 1100:1100 /home/docker/supermap_onewindow/config


```

2、部署 database 

- 建立 database 的 stack
- 确认 docker-compose.xml 中的配置
- 执行 start
- 初始化 mysql：远程登陆 mysql 之后，执行建库语句
- 初始化 influxdb：进入 influxdb 容器，执行命令

```
docker exec -it supermap.influxdb influx
#进入后：
show databases
show users
# 创建数据库
create database "monitor"
# 创建用户
create user "monitor" with password 'monitorpassword' with all privileges
create user "root" with password 'rootpassword' with all privileges

```

3、部署 infrastructure

- 建立 infrastructure 的 stack
- 确认 docker-compose.xml 中的配置
- 执行 start
- 初始化 nacos：登陆 nacos 页面，上传配置文件
- 初始化 grafana：登陆 grafana 页面，上传监控文件
- 初始化 graylog：登陆 graylog 页面，新建日志通道

4、部署 bootstrap



备注：

预发布环境，因为开发机无法直接连接oracle数据库，就走了一次nginx缓存。
这部分的配置也在 nacos 里面